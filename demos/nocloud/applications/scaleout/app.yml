---
- hosts: localhost
  connection: local
  vars_files:
    - ../../../../vars/avi_details.yaml
  tasks:

    - name: Avi Application | Setup Scaleout-pool
      community.network.avi_pool:
          api_version: "{{ api_version }}"
          controller: "{{ controller_ip }}"
          username: "{{ username }}"
          password: "{{ password }}"
          tenant: admin      
          name: Avi-Scaleout-pool
          lb_algorithm: LB_ALGORITHM_LEAST_CONNECTIONS
          health_monitor_refs:
            - "/api/healthmonitor?name=System-HTTP"
          servers:
            - hostname: "demoserver1.avinet"
              #resolve_server_by_dns: true
              ip:
                 addr: "169.254.127.200"
                 type: 'V4'
            - hostname: "demoserver1.avinet"
              #resolve_server_by_dns: true
              ip:
                 addr: "169.254.127.201"
                 type: 'V4'
          analytics_policy:
              enable_realtime_metrics: true                   

    - community.network.avi_vsvip:
          api_version: "{{ api_version }}"
          controller: "{{ controller_ip }}"
          username: "{{ username }}"
          password: "{{ password }}"
          tenant: admin      
          name: Avi-Scaleout-VS-vsvip
          vip:
            - ip_address:
                addr: "169.254.10.2"
                type: 'V4'
              vip_id: '1'

    - community.network.avi_virtualservice:
          api_version: "{{ api_version }}"
          controller: "{{ controller_ip }}"
          username: "{{ username }}"
          password: "{{ password }}"
          tenant: admin      
          name: Avi-Scaleout-VS
          vsvip_ref: '/api/vsvip?name=Avi-Scaleout-VS-vsvip'
          services:
            - port: 80
            - port: 443
              enable_ssl: true
          application_profile_ref: "/api/applicationprofile?name=System-Secure-HTTP"
          ssl_key_and_certificate_refs:
            - "/api/sslkeyandcertificate?name=System-Default-Cert"
            - "/api/sslkeyandcertificate?name=System-Default-Cert-EC"
          ssl_profile_ref: '/api/sslprofile?name=System-Standard'
          pool_ref: '/api/pool?name=Avi-Scaleout-pool'
          analytics_policy:
            udf_log_throttle: 0
            #enabled: true
            full_client_logs:
              duration: 0
              throttle: 0
              enabled: true
            metrics_realtime_update:
              duration: 0
              enabled: true
            significant_log_throttle: 0
            all_headers: true
            client_insights: NO_INSIGHTS
            
